package validator

import (
	"fmt"
	"strings"

	"github.com/gin-gonic/gin/binding"
	"github.com/go-playground/validator/v10"
	"{{.ModuleName}}/config"
)

func RegisterUniqueColumnValidator() {
	if v, ok := binding.Validator.Engine().(*validator.Validate); ok {
		err := v.RegisterValidation("unique_column", func(fl validator.FieldLevel) bool {
			param := fl.Param()
			parts := strings.Split(param, " ")
			if len(parts) != 2 {
				return false
			}

			table := strings.TrimSpace(parts[0])
			column := strings.TrimSpace(parts[1])
			value := fl.Field().Interface()

			var count int64
			if err := config.
				DB.
				Table(table).
				Where(fmt.Sprintf("%s = ?", column), value).
				Count(&count).Error; err != nil {
				return false
			}

			return count == 0
		})

		if err != nil {
			return
		}
	}
}
